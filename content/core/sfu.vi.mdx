---
title: SFU
---

import { SatelliteDish, Video } from "lucide-react";

<Callout title="SFU l√† g√¨?" icon={<SatelliteDish />}>
  **Selective Forwarding Unit (SFU)** nh·∫≠n c√°c lu·ªìng media t·ª´ ng∆∞·ªùi tham gia
  v√† chuy·ªÉn ti·∫øp ch√∫ng ƒë·∫øn nh·ªØng ng∆∞·ªùi kh√°c m√† kh√¥ng gi·∫£i m√£ hay m√£ h√≥a l·∫°i. 
  ƒêi·ªÅu n√†y gi√∫p ƒë·∫°t ƒë∆∞·ª£c **ƒë·ªô tr·ªÖ th·∫•p** v√† **kh·∫£ nƒÉng m·ªü r·ªông** trong truy·ªÅn th√¥ng th·ªùi gian th·ª±c.
</Callout>

SFU c·ªßa Waterbus l√† trung t√¢m c·ªßa h·∫° t·∫ßng media th·ªùi gian th·ª±c. ƒê∆∞·ª£c x√¢y d·ª±ng b·∫±ng **Rust**, n√≥ ƒë∆∞·ª£c t·ªëi ∆∞u v·ªÅ hi·ªáu su·∫•t v√† ƒë·ªô tin c·∫≠y, h·ªó tr·ª£ c√°c t√≠nh nƒÉng WebRTC hi·ªán ƒë·∫°i nh∆∞ **Simulcast**, **Scalable Video Coding (SVC)** v√† chuy·ªÉn ti·∫øp th√≠ch ·ª©ng d·ª±a tr√™n bƒÉng th√¥ng v·ªõi **Transport-Wide Congestion Control (TWCC)** v√† **Receiver Estimated Maximum Bitrate (REMB)**.

---

## Tr√°ch nhi·ªám

Node SFU ch·ªãu tr√°ch nhi·ªám:

- üì° **Nh·∫≠n k·∫øt n·ªëi Peer**  
  Ch·∫•p nh·∫≠n k·∫øt n·ªëi WebRTC, x·ª≠ l√Ω ICE, DTLS v√† gi·∫£i m√£ c√°c lu·ªìng SRTP.

- üîÄ **ƒê·ªãnh tuy·∫øn media**  
  Chuy·ªÉn ti·∫øp c√°c g√≥i RTP ƒë·∫øn t·∫•t c·∫£ c√°c subscriber c·ªßa m·ªôt track v·ªõi ƒë·ªô tr·ªÖ t·ªëi thi·ªÉu.

- ‚öôÔ∏è **Chuy·ªÉn ƒë·ªïi ch·∫•t l∆∞·ª£ng th√≠ch ·ª©ng**  
  T·ª± ƒë·ªông ch·ªçn ch·∫•t l∆∞·ª£ng t·ªët nh·∫•t (l·ªõp Simulcast ho·∫∑c SVC) cho t·ª´ng subscriber d·ª±a tr√™n ph·∫£n h·ªìi m·∫°ng th·ªùi gian th·ª±c t·ª´ TWCC v√† REMB.

- üîÅ **Thay th·∫ø track**  
  Chuy·ªÉn ƒë·ªïi m∆∞·ª£t m√† gi·ªØa c√°c l·ªõp video ho·∫∑c ch·∫•t l∆∞·ª£ng kh√°c nhau m√† kh√¥ng g√¢y gi√°n ƒëo·∫°n.

- üì§ **Chuy·ªÉn ti·∫øp Egress**  
  G·ª≠i c√°c lu·ªìng ƒë√£ ch·ªçn ƒë·∫øn pipeline egress nh∆∞ **HLS** ho·∫∑c **MoQ** ƒë·ªÉ ghi l·∫°i ƒë√°m m√¢y ho·∫∑c ph√°t s√≥ng tr·ª±c ti·∫øp.

- üß† **Ph·∫£n h·ªìi t·ª´ publisher v·ªÅ l·ªõp video kh√¥ng d√πng**  
  Th√¥ng b√°o cho publisher ng·ª´ng g·ª≠i c√°c l·ªõp Simulcast ho·∫∑c SVC kh√¥ng c√≥ subscriber d√πng ‚Äî ti·∫øt ki·ªám **bƒÉng th√¥ng** v√† **pin thi·∫øt b·ªã**.

---

## C√°ch ho·∫°t ƒë·ªông

M·ªói ng∆∞·ªùi tham gia thi·∫øt l·∫≠p k·∫øt n·ªëi WebRTC v·ªõi SFU. Lu·ªìng ho·∫°t ƒë·ªông:

1. **ƒê√†m ph√°n** ICE, DTLS, v√† SRTP.
2. **Nh·∫≠n media** c√°c g√≥i RTP ƒë√£ m√£ h√≥a (v√≠ d·ª• VP8, H264 cho video; Opus cho audio).
3. **Chuy·ªÉn ti·∫øp media** ƒë·∫øn m·ªôt ho·∫∑c nhi·ªÅu subscriber.
4. **Gi√°m s√°t bƒÉng th√¥ng** qua c√°c v√≤ng ph·∫£n h·ªìi TWCC v√† REMB.
5. **Chuy·ªÉn ƒë·ªïi l·ªõp ƒë·ªông** d·ª±a tr√™n ƒëi·ªÅu ki·ªán m·∫°ng th·ªùi gian th·ª±c.
6. **Ph·ªëi h·ª£p v·ªõi publisher** ƒë·ªÉ gi·∫£m s·ª≠ d·ª•ng uplink kh√¥ng c·∫ßn thi·∫øt.

---

## H·ªó tr·ª£ Simulcast v√† SVC v·ªõi TWCC

Waterbus h·ªó tr·ª£:

- **Simulcast**: Nhi·ªÅu lu·ªìng video v·ªõi c√°c ƒë·ªô ph√¢n gi·∫£i kh√°c nhau (v√≠ d·ª• 720p, 480p, 240p).
- **SVC (Scalable Video Coding)**: M·ªôt lu·ªìng m√£ h√≥a v·ªõi nhi·ªÅu l·ªõp n√¢ng cao (theo th·ªùi gian, kh√¥ng gian).

Nh·ªù **TWCC (Transport-Wide Congestion Control)**, SFU ƒëo ch√≠nh x√°c hi·ªáu su·∫•t m·∫°ng nh∆∞ m·∫•t g√≥i d·ªØ li·ªáu v√† RTT cho t·ª´ng subscriber. ƒêi·ªÅu n√†y cho ph√©p:

- ƒêi·ªÅu ch·ªânh ch·∫•t l∆∞·ª£ng theo t·ª´ng subscriber.
- T·ª± ƒë·ªông chuy·ªÉn ƒë·ªïi l·ªõp (v√≠ d·ª• t·ª´ 720p xu·ªëng 480p khi m·∫°ng y·∫øu).
- Logic ƒëƒÉng k√Ω th√¥ng minh ƒë·ªÉ tr√°nh qu√° t·∫£i k·∫øt n·ªëi y·∫øu.

---

## V√≠ d·ª• th·ª±c t·∫ø: Publisher g·ª≠i c√°c l·ªõp f, h, q

Gi·∫£ s·ª≠ publisher g·ª≠i 3 l·ªõp Simulcast:

- `f` = ƒê·ªô ph√¢n gi·∫£i ƒë·∫ßy ƒë·ªß (v√≠ d·ª• 1280x720)
- `h` = ƒê·ªô ph√¢n gi·∫£i m·ªôt n·ª≠a (v√≠ d·ª• 640x360)
- `q` = ƒê·ªô ph√¢n gi·∫£i m·ªôt ph·∫ßn t∆∞ (v√≠ d·ª• 320x180)

Ban ƒë·∫ßu, t·∫•t c·∫£ c√°c layer ƒë∆∞·ª£c g·ª≠i ƒë·∫øn SFU.

B√¢y gi·ªù, gi·∫£ s·ª≠:

- Ch·ªâ c√≥ m·ªôt subscriber ƒëang xem.
- Subscriber n√†y m·∫°ng k√©m v√† ch·ªâ nh·∫≠n layer `q`.

### T·ªëi ∆∞u h√≥a

- SFU ph√°t hi·ªán kh√¥ng c√≥ subscriber n√†o d√πng layer `h` ho·∫∑c `f`.
- SFU g·ª≠i **Th√¥ng b√°o ph·∫£n h·ªìi layer (Layer Feedback Message)** ƒë·∫øn publisher:

  > ‚ÄúD·ª´ng g·ª≠i layer `h` ‚Äî hi·ªán t·∫°i kh√¥ng ai s·ª≠ d·ª•ng.‚Äù

- Publisher **t·∫°m d·ª´ng** layer `h`.
- K·∫øt qu·∫£: **CPU gi·∫£m t·∫£i**, **bƒÉng th√¥ng upload gi·∫£m** tr√™n thi·∫øt b·ªã publisher v√† **gi·∫£m t·∫£i x·ª≠ l√Ω** cho SFU.

N·∫øu sau ƒë√≥ c√≥ subscriber m·ªõi v·ªõi m·∫°ng t·ªët tham gia, SFU s·∫Ω y√™u c·∫ßu:

> ‚ÄúVui l√≤ng ti·∫øp t·ª•c g·ª≠i layer `h` ‚Äî c√≥ ng∆∞·ªùi xem c·∫ßn.‚Äù

C√°ch ti·∫øp c·∫≠n n√†y gi√∫p **t·ªëi ∆∞u t√†i nguy√™n th·ªùi gian th·ª±c**, r·∫•t ph√π h·ª£p cho ng∆∞·ªùi d√πng di ƒë·ªông v√† ph√°t s√≥ng quy m√¥ l·ªõn.

---

## T·ªïng quan ki·∫øn tr√∫c

Node SFU t√≠ch h·ª£p v·ªõi c√°c th√†nh ph·∫ßn kh√°c nh∆∞ **Dispatcher** (qu·∫£n l√Ω ph√≤ng) v√† **Egress Modules** (xu·∫•t lu·ªìng):

- Node SFU l√† **stateless** ‚Äî kh√¥ng l∆∞u tr·ªØ l·ªãch s·ª≠ media.
- Tr·∫°ng th√°i ph√≤ng v√† ph√¢n b·ªï phi√™n ƒë∆∞·ª£c **Dispatcher** qu·∫£n l√Ω qua **etcd**.
- Thi·∫øt k·∫ø n√†y cho ph√©p **m·ªü r·ªông ngang**, kh·∫£ nƒÉng ch·ªãu l·ªói v√† ph·ª•c h·ªìi nhanh.
